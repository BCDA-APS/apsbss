

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>apsbss: IOC Startup and Management &#8212; apsbss 1.5.4rc3 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bizstyle.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="APS Proposal and ESAF Support" href="source/index.html" />
    <link rel="prev" title="apsbss" href="apsbss.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="source/index.html" title="APS Proposal and ESAF Support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="apsbss.html" title="apsbss"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">apsbss 1.5.4rc3 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">apsbss: IOC Startup and Management</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="apsbss-ioc-startup-and-management">
<span id="apsbss-ioc"></span><h1>apsbss: IOC Startup and Management<a class="headerlink" href="#apsbss-ioc-startup-and-management" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="apsbss.html#apsbss-application"><span class="std std-ref">apsbss</span></a> software
provides information from the APS Proposal
and ESAF (experiment safety approval
form) databases as PVs to the local controls network.
The <code class="docutils literal notranslate"><span class="pre">aps-dm-api</span></code> (<code class="docutils literal notranslate"><span class="pre">dm</span></code> for short) package <a class="footnote-reference brackets" href="#id2" id="id1">1</a>
is used to access the APS databases as read-only.
The information in the PVs can be used as metadata
for inclusion in data files produced</p>
<p><em>No information is written back to the APS
databases from this software.</em></p>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">dm</span></code>: <a class="reference external" href="https://anaconda.org/search?q=aps-dm-api">https://anaconda.org/search?q=aps-dm-api</a></p>
</dd>
</dl>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Create the PVs in an EPICS IOC</p></li>
<li><p>Initialize PVs with beam line name and APS run cycle number</p></li>
<li><p>Set PV with the Proposal ID number</p></li>
<li><p>Set PV with the ESAF ID number</p></li>
<li><p>Retrieve (&amp; update PVs) information from APS databases</p></li>
</ol>
</section>
<section id="start-epics-ioc">
<span id="apsbss-ioc-management"></span><h2>Start EPICS IOC<a class="headerlink" href="#start-epics-ioc" title="Permalink to this headline">¶</a></h2>
<p>The EPICS Process Variables (PVs) that support this software
are provided by an EPICS PV server (IOC).  The PVs are defined
by including the <code class="docutils literal notranslate"><span class="pre">apsbss.db</span></code> database file in the startup
of the IOC.  The database can be add to an existing IOC
or run as a stand-alone IOC using the <code class="docutils literal notranslate"><span class="pre">softIoc</span></code> application
from EPICS base.</p>
<p>To ensure that we create PVs with unique names, decide what
prefix to use with the EPICS database.  Such as, for APS beam
line 9-ID, you might pick: <code class="docutils literal notranslate"><span class="pre">9id:bss:</span></code> (making sure to end
the prefix with the customary <code class="docutils literal notranslate"><span class="pre">:</span></code>).</p>
<section id="add-epics-database-to-existing-ioc">
<h3>Add EPICS database to existing IOC<a class="headerlink" href="#add-epics-database-to-existing-ioc" title="Permalink to this headline">¶</a></h3>
<p>To include <code class="docutils literal notranslate"><span class="pre">apsbss.db</span></code> in an existing IOC, copy the file
(see Downloads below) into the IOC’s startup directory
(typically the directory with <code class="docutils literal notranslate"><span class="pre">st.cmd</span></code>).  Edit the <code class="docutils literal notranslate"><span class="pre">st.cmd</span></code>
file and a line like this just before the call to <code class="docutils literal notranslate"><span class="pre">iocInit</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbLoadRecords</span><span class="p">(</span><span class="s2">&quot;apsbss.db&quot;</span><span class="p">,</span> <span class="s2">&quot;P=9id:bss:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the IOC is started, these PVs should be available to any
EPICS client on the local network.</p>
</section>
<section id="run-epics-database-in-softioc-from-epics-base">
<h3>Run EPICS database in softIoc from EPICS Base<a class="headerlink" href="#run-epics-database-in-softioc-from-epics-base" title="Permalink to this headline">¶</a></h3>
<p>For this example, we pick a unique name for this process,
(<code class="docutils literal notranslate"><span class="pre">ioc9idbss</span></code>) based on the PV prefix (<code class="docutils literal notranslate"><span class="pre">9id:bss:</span></code>).</p>
<aside class="sidebar">
<p class="sidebar-title">TIP</p>
<p>If you customize your copy of <code class="docutils literal notranslate"><span class="pre">apsbss_ioc.sh</span></code>
and pre-define the two lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># change the program defaults here</span>
<span class="n">DEFAULT_SESSION_NAME</span><span class="o">=</span><span class="n">apsbss</span>
<span class="n">DEFAULT_IOC_PREFIX</span><span class="o">=</span><span class="n">ioc</span><span class="p">:</span><span class="n">bss</span><span class="p">:</span>
</pre></div>
</div>
<p>then you do not need to supply these terms as
command-line arguments.  The usage command
will show these the default names you provided.</p>
</aside>
<p><strong>Start</strong> the IOC using the <code class="docutils literal notranslate"><span class="pre">apsbss_ioc.sh</span></code> tool
(as described below), with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apsbss_ioc.sh start ioc9idbss 9id:bss:
Starting ioc9idbss with IOC prefix 9id:bss:
</pre></div>
</div>
<p><strong>Stop</strong> the IOC with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apsbss_ioc.sh stop ioc9idbss 9id:bss:
ioc9idbss is not running
</pre></div>
</div>
<p>The IOC <strong>restart</strong> command, will first stop the IOC (if
it is running), then start it.</p>
<p>Report whether or not the IOC is running with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apsbss_ioc.sh status ioc9idbss 9id:bss:
ioc9idbss is not running
</pre></div>
</div>
<p>To interact with the <strong>console</strong> of an IOC running in
a <code class="docutils literal notranslate"><span class="pre">screen</span></code> session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apsbss_ioc.sh console ioc9idbss 9id:bss:
</pre></div>
</div>
<p>To end this interaction, type <code class="docutils literal notranslate"><span class="pre">^A</span></code> then <code class="docutils literal notranslate"><span class="pre">D</span></code> which will
leave the IOC running.  Type <code class="docutils literal notranslate"><span class="pre">exit</span></code> to stop the IOC from
the console.</p>
<p>For diagnostic (or other) purposes, you can also run the IOC
without using a screen session.  This is the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apsbss_ioc.sh run ioc9idbss 9id:bss:
dbLoadDatabase(&quot;/home/beams1/JEMIAN/.conda/envs/bluesky_2020_5/epics/bin/linux-x86_64/../../dbd/softIoc.dbd&quot;)
softIoc_registerRecordDeviceDriver(pdbbase)
dbLoadRecords(&quot;apsbss.db&quot;, &quot;P=9id:bss:&quot;)
iocInit()
Starting iocInit
############################################################################
## EPICS R7.0.4
## Rev. 2020-05-29T13:39+0000
############################################################################
cas warning: Configured TCP port was unavailable.
cas warning: Using dynamically assigned TCP port 39809,
cas warning: but now two or more servers share the same UDP port.
cas warning: Depending on your IP kernel this server may not be
cas warning: reachable with UDP unicast (a host&#39;s IP in EPICS_CA_ADDR_LIST)
iocRun: All initialization complete
epics&gt;
</pre></div>
</div>
<p>You should see the IOC shell prompt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``epics&gt; ``
</pre></div>
</div>
<p>If you type <code class="docutils literal notranslate"><span class="pre">exit</span></code> or otherwise close the session, the IOC will exit.</p>
<section id="shell-script-to-manage-softioc">
<h4>Shell Script to manage softIoc<a class="headerlink" href="#shell-script-to-manage-softioc" title="Permalink to this headline">¶</a></h4>
<p>To run a stand-alone IOC using the <code class="docutils literal notranslate"><span class="pre">softIoc</span></code> application
from EPICS base, use the supplied IOC management shell script
<code class="docutils literal notranslate"><span class="pre">apsbss_ioc.sh</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apsbss_ioc.sh
Usage: apsbss_ioc.sh {start|stop|restart|status|checkup|console|run} [NAME [PREFIX]]

        COMMANDS
                console   attach to IOC console if IOC is running in screen
                checkup   check that IOC is running, restart if not
                restart   restart IOC
                run       run IOC in console (not screen)
                start     start IOC
                status    report if IOC is running
                stop      stop IOC

        OPTIONAL TERMS
                NAME      name of IOC session (default: apsbss)
                PREFIX    IOC prefix (default: ioc:bss:)
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="_downloads/46c2c44d7f66c7e2364ade0357376d16/apsbss.db"><code class="xref download docutils literal notranslate"><span class="pre">apsbss.db</span></code></a></p></li>
<li><p><a class="reference download internal" download="" href="_downloads/f93f174d713b0aa51f2edc567a19a2fb/apsbss_ioc.sh"><code class="xref download docutils literal notranslate"><span class="pre">apsbss_ioc.sh</span></code></a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The shell script assumes that a working <code class="docutils literal notranslate"><span class="pre">softIoc</span></code> application
(from EPICS base) is in your executable <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>.  You should confirm
this first before trying to start the IOC.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">softIoc</span></code> application is run within a <code class="docutils literal notranslate"><span class="pre">screen</span></code>
session so that it remains running even if you close the
console session.  Confirm that you have the <code class="docutils literal notranslate"><span class="pre">screen</span></code> application
first before trying to start the IOC.</p>
</div>
<p>Here’s an example starter script for the IOC from APS 9-ID-C (USAXS).
This shell script is stored as file <cite>~/bin/ioc9idcbss.sh</cite> with
executable permissions:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">PROCESS_NAME</span><span class="o">=</span>ioc9idcbss
<span class="nv">IOC_PREFIX</span><span class="o">=</span>9idc:bss:

<span class="c1"># activate the bluesky environment</span>
<span class="nv">BLUESKY</span><span class="o">=</span>/APSshare/anaconda3/Bluesky
<span class="nb">source</span> <span class="si">${</span><span class="nv">BLUESKY</span><span class="si">}</span>/bin/activate base

<span class="c1"># need shell script and EPICS database file</span>
<span class="nv">APSBSS</span><span class="o">=</span><span class="k">$(</span>dirname <span class="k">$(</span>python -c <span class="s2">&quot;import apsbss; print(apsbss.__file__)&quot;</span><span class="k">))</span>

<span class="c1"># need EPICS base/bin/softIoc from this path</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span>:/APSshare/epics/base-7.0.3/bin/<span class="si">${</span><span class="nv">EPICS_HOST_ARCH</span><span class="si">}</span>

<span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">APSBSS</span><span class="si">}</span><span class="s2">&quot;</span>
./apsbss_ioc.sh  <span class="s2">&quot;</span><span class="si">${</span><span class="p">@</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROCESS_NAME</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">IOC_PREFIX</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Here’s an example cron task for the IOC from APS 9-ID-C (USAXS)
to keep the softIoc running (and start the IOC after system reboot):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>*/2 * * * * /home/beams/USAXS/bin/ioc9idcbss.sh checkup 2&gt;&amp;1 &gt; /dev/null
</pre></div>
</div>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">apsbss: IOC Startup and Management</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#start-epics-ioc">Start EPICS IOC</a><ul>
<li><a class="reference internal" href="#add-epics-database-to-existing-ioc">Add EPICS database to existing IOC</a></li>
<li><a class="reference internal" href="#run-epics-database-in-softioc-from-epics-base">Run EPICS database in softIoc from EPICS Base</a><ul>
<li><a class="reference internal" href="#shell-script-to-manage-softioc">Shell Script to manage softIoc</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="apsbss.html"
                        title="previous chapter">apsbss</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="source/index.html"
                        title="next chapter">APS Proposal and ESAF Support</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/apsbss_ioc.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="source/index.html" title="APS Proposal and ESAF Support"
             >next</a> |</li>
        <li class="right" >
          <a href="apsbss.html" title="apsbss"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">apsbss 1.5.4rc3 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">apsbss: IOC Startup and Management</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.0.
    </div>
  </body>
</html>